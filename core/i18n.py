TEXTS = {
    "ru": {
        "choose_lang": "🌍 Пожалуйста, выберите язык:",
        "welcome_back": "👋 С возвращением, {name}!",
        "enter_nick": "👋 Привет! Введи свой ник:",
        "pick_theme": "Выбери интересующую тему:",
        "found": "🎉 Собеседник найден!\nТема: {theme}\nПодтема: {sub}\nЯзык собеседника: {lang}",
        # кнопки
        "btn_start": "Начать",
        "btn_search": "🔍 Начать поиск",
        "btn_stop": "⛔ Остановить поиск",
        "btn_change_sub": "Изменить подтему",
        "btn_main_menu": "🏠 Главное меню",
        "btn_support": "❤️ Поддержать проект",
        "choose_gender": "Укажи свой пол:",
        "wrong_gender": "Пожалуйста, выбери пол:",
        "choose_sub": "Теперь выбери подтему:",
        "wrong_sub": "Пожалуйста, выбери подтему из списка.",
        "searching": "🔎 Ищем собеседника...",
        "search_stopped": "Поиск остановлен.",
        "main_menu": "Выберите действие:",
        "pick_sub": "Выберите новую подтему:",
        "default_searching": "⏳ Ищем собеседника...",
        "error_fallback": "❌ Что-то пошло не так. Напиши /start.",
    },
    "uk": {
        "choose_lang": "🌍 Будь ласка, оберіть мову:",
        "welcome_back": "👋 З поверненням, {name}!",
        "enter_nick": "👋 Привіт! Введи свій нік:",
        "pick_theme": "Обери тему:",
        "found": "🎉 Співрозмовника знайдено!\nТема: {theme}\nПідтема: {sub}\nМова співрозмовника: {lang}",
        "btn_start": "Почати",
        "btn_search": "🔍 Почати пошук",
        "btn_stop": "⛔ Зупинити пошук",
        "btn_change_sub": "Змінити підтему",
        "btn_main_menu": "🏠 Головне меню",
        "btn_support": "❤️ Підтримати проект",
        "choose_gender": "Оберіть свою стать:",
        "wrong_gender": "Будь ласка, оберіть стать:",
        "choose_sub": "Тепер оберіть підтему:",
        "wrong_sub": "Будь ласка, оберіть підтему зі списку.",
        "searching": "🔎 Пошук співрозмовника...",
        "search_stopped": "Пошук зупинено.",
        "main_menu": "Оберіть дію:",
        "pick_sub": "Оберіть нову підтему:",
        "default_searching": "⏳ Пошук триває...",
        "error_fallback": "❌ Щось пішло не так. Напишіть /start.",
    },
    "en": {
        "choose_lang": "🌍 Please choose your language:",
        "welcome_back": "👋 Welcome back, {name}!",
        "enter_nick": "👋 Hi! Enter your nickname:",
        "pick_theme": "Choose a topic:",
        "found": "🎉 Partner found!\nTopic: {theme}\nSubtopic: {sub}\nPartner language: {lang}",
        "btn_start": "Start",
        "btn_search": "🔍 Start search",
        "btn_stop": "⛔ Stop search",
        "btn_change_sub": "Change subtopic",
        "btn_main_menu": "🏠 Main menu",
        "btn_support": "❤️ Support the project",
        "choose_gender": "Select your gender:",
        "wrong_gender": "Please select your gender:",
        "choose_sub": "Now choose a subtopic:",
        "wrong_sub": "Please select a subtopic from the list.",
        "searching": "🔎 Looking for a partner...",
        "search_stopped": "Search stopped.",
        "main_menu": "Choose an action:",
        "pick_sub": "Select a new subtopic:",
        "default_searching": "⏳ Still looking for a partner...",
        "error_fallback": "❌ Something went wrong. Please send /start.",
    },
    "es": {
        "choose_lang": "🌍 Por favor, elige un idioma:",
        "welcome_back": "👋 ¡Bienvenido de nuevo, {name}!",
        "enter_nick": "👋 ¡Hola! Escribe tu apodo:",
        "pick_theme": "Elige un tema:",
        "found": "🎉 ¡Pareja encontrada!\nTema: {theme}\nSubtema: {sub}\nIdioma del interlocutor: {lang}",
        "btn_start": "Comenzar",
        "btn_search": "🔍 Buscar",
        "btn_stop": "⛔ Detener búsqueda",
        "btn_change_sub": "Cambiar subtema",
        "btn_main_menu": "🏠 Menú principal",
        "btn_support": "❤️ Apoyar el proyecto",
        "choose_gender": "Selecciona tu género:",
        "wrong_gender": "Por favor, selecciona tu género:",
        "choose_sub": "Ahora elige un subtema:",
        "wrong_sub": "Por favor, elige un subtema de la lista.",
        "searching": "🔎 Buscando compañero...",
        "search_stopped": "Búsqueda detenida.",
        "main_menu": "Elige una acción:",
        "pick_sub": "Elige un nuevo subtema:",
        "default_searching": "⏳ Buscando compañero...",
        "error_fallback": "❌ Algo salió mal. Escribe /start.",
    },
    "fr": {
        "choose_lang": "🌍 Veuillez choisir votre langue :",
        "welcome_back": "👋 Bon retour, {name} !",
        "enter_nick": "👋 Salut ! Entrez votre pseudo :",
        "pick_theme": "Choisissez un thème :",
        "found": "🎉 Partenaire trouvé !\nThème : {theme}\nSous‑thème : {sub}\nLangue du partenaire : {lang}",
        "btn_start": "Commencer",
        "btn_search": "🔍 Lancer la recherche",
        "btn_stop": "⛔ Arrêter la recherche",
        "btn_change_sub": "Changer le sous‑thème",
        "btn_main_menu": "🏠 Menu principal",
        "btn_support": "❤️ Soutenir le projet",
        "choose_gender": "Indique ton sexe :",
        "wrong_gender": "Veuillez choisir votre sexe :",
        "choose_sub": "Choisis maintenant une sous-thème :",
        "wrong_sub": "Veuillez choisir une sous-thème dans la liste.",
        "searching": "🔎 Recherche d’un partenaire...",
        "search_stopped": "Recherche arrêtée.",
        "main_menu": "Choisissez une action :",
        "pick_sub": "Choisissez une nouvelle sous-thème :",
        "default_searching": "⏳ Recherche en cours...",
        "error_fallback": "❌ Une erreur est survenue. Envoyez /start.",
    },
    "de": {
        "choose_lang": "🌍 Bitte wähle eine Sprache:",
        "welcome_back": "👋 Willkommen zurück, {name}!",
        "enter_nick": "👋 Hallo! Gib deinen Nick ein:",
        "pick_theme": "Wähle ein Thema:",
        "found": "🎉 Gesprächspartner gefunden!\nThema: {theme}\nUnterthema: {sub}\nSprache des Partners: {lang}",
        "btn_start": "Start",
        "btn_search": "🔍 Suche starten",
        "btn_stop": "⛔ Suche stoppen",
        "btn_change_sub": "Unterthema ändern",
        "btn_main_menu": "🏠 Hauptmenü",
        "btn_support": "❤️ Projekt unterstützen",
        "choose_gender": "Wähle dein Geschlecht:",
        "wrong_gender": "Bitte wähle dein Geschlecht:",
        "choose_sub": "Wähle jetzt ein Unterthema:",
        "wrong_sub": "Bitte wähle ein Unterthema aus der Liste.",
        "searching": "🔎 Suche nach Gesprächspartner...",
        "search_stopped": "Suche gestoppt.",
        "main_menu": "Wähle eine Aktion:",
        "pick_sub": "Wähle ein neues Unterthema:",
        "default_searching": "⏳ Suche läuft...",
        "error_fallback": "❌ Etwas ist schiefgelaufen. Sende /start.",
    },
}

def tr_lang(lang: str, key: str, **kw) -> str:
    lang = lang if lang in TEXTS else "ru"
    return TEXTS[lang].get(key, key).format(**kw)

async def tr(user, key: str, **kw) -> str:
    # user может быть dict (из get_user) или telegram.User
    lang = "ru"
    if isinstance(user, dict):
        lang = user.get("lang", "ru")
    elif hasattr(user, "id"):
        from db.user_queries import get_user
        row = await get_user(user.id)
        if row:
            lang = row.get("lang", "ru")
    return tr_lang(lang, key, **kw)
