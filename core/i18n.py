TEXTS = {
    "ru": {
        "choose_lang": "🌍 Пожалуйста, выберите язык:",
        "welcome_back": "👋 С возвращением, {name}!",
        "enter_nick": "👋 Привет! Введи свой ник:",
        "pick_theme": "Выбери интересующую тему:",
        "choose_sub": "Теперь выбери подтему:",
        "pick_sub": "Выберите новую подтему:",
        "wrong_sub": "Пожалуйста, выбери подтему из списка.",
        "choose_gender": "Укажи свой пол:",
        "wrong_gender": "Пожалуйста, выбери пол:",
        "found": "🎉 Собеседник найден!\nТема: {theme}\nПодтема: {sub}\nЯзык собеседника: {lang}",
        "main_menu": "Выберите действие:",
        "searching": "🔎 Ищем собеседника...",
        "default_searching": "⏳ Ищем собеседника...",
        "search_stopped": "Поиск остановлен.",
        "error_fallback": "❌ Что-то пошло не так. Напиши /start.",
        "sub_any": "Любая подтема",
        "support_thanks": "🙏 Спасибо за поддержку!\n(Здесь будет ссылка на донат)",

        # Кнопки
        "btn_start": "Начать",
        "btn_search": "🔍 Начать поиск",
        "btn_stop": "⛔ Остановить поиск",
        "btn_change_sub": "Изменить подтему",
        "btn_main_menu": "🏠 Главное меню",
        "btn_support": "❤️ Поддержать проект",
        "btn_end_dialog": "❌ Завершить диалог",
        "btn_new_partner": "🔍 Новый собеседник",
        "pls_start": "Пожалуйста, отправьте /start.",
        "btn_end": "❌ Завершить диалог",

        # Пол
        "gender_male": "Мужской",
        "gender_female": "Женский",
        "gender_any": "Не важно",

        # Вывод
        "confirm_theme": "Вы выбрали тему: {theme}",
        "confirm_sub": "И подтему: {sub}",
    },
    "uk": {
        "choose_lang": "🌍 Будь ласка, оберіть мову:",
        "welcome_back": "👋 З поверненням, {name}!",
        "enter_nick": "👋 Привіт! Введи свій нік:",
        "pick_theme": "Обери тему:",
        "choose_sub": "Тепер оберіть підтему:",
        "pick_sub": "Оберіть нову підтему:",
        "wrong_sub": "Будь ласка, оберіть підтему зі списку.",
        "choose_gender": "Оберіть свою стать:",
        "wrong_gender": "Будь ласка, оберіть стать:",
        "found": "🎉 Співрозмовника знайдено!\nТема: {theme}\nПідтема: {sub}\nМова співрозмовника: {lang}",
        "main_menu": "Оберіть дію:",
        "searching": "🔎 Пошук співрозмовника...",
        "default_searching": "⏳ Пошук триває...",
        "search_stopped": "Пошук зупинено.",
        "error_fallback": "❌ Щось пішло не так. Напишіть /start.",
        "sub_any": "Будь-яка підтема",
        "support_thanks": "🙏 Дякуємо за підтримку!\n(Тут буде посилання на донат)",

        "btn_start": "Почати",
        "btn_search": "🔍 Почати пошук",
        "btn_stop": "⛔ Зупинити пошук",
        "btn_change_sub": "Змінити підтему",
        "btn_main_menu": "🏠 Головне меню",
        "btn_support": "❤️ Підтримати проект",
        "btn_end_dialog": "❌ Завершити діалог",
        "btn_new_partner": "🔍 Новий співрозмовник",
        "pls_start": "Будь ласка, надішліть /start.",
        "btn_end": "❌ Завершити діалог",

        "gender_male": "Чоловіча",
        "gender_female": "Жіноча",
        "gender_any": "Неважливо",

        "confirm_theme": "Ви обрали тему: {theme}",
        "confirm_sub": "Та підтему: {sub}",
        
    },
    "en": {
        "choose_lang": "🌍 Please choose your language:",
        "welcome_back": "👋 Welcome back, {name}!",
        "enter_nick": "👋 Hi! Enter your nickname:",
        "pick_theme": "Choose a topic:",
        "choose_sub": "Now choose a subtopic:",
        "pick_sub": "Select a new subtopic:",
        "wrong_sub": "Please select a subtopic from the list.",
        "choose_gender": "Select your gender:",
        "wrong_gender": "Please select your gender:",
        "found": "🎉 Partner found!\nTopic: {theme}\nSubtopic: {sub}\nPartner language: {lang}",
        "main_menu": "Choose an action:",
        "searching": "🔎 Looking for a partner...",
        "default_searching": "⏳ Still looking for a partner...",
        "search_stopped": "Search stopped.",
        "error_fallback": "❌ Something went wrong. Please send /start.",
        "sub_any": "Any subtopic",
        "support_thanks": "🙏 Thanks for your support!\n(A donation link will appear here)",

        "btn_start": "Start",
        "btn_search": "🔍 Start search",
        "btn_stop": "⛔ Stop search",
        "btn_change_sub": "Change subtopic",
        "btn_main_menu": "🏠 Main menu",
        "btn_support": "❤️ Support the project",
        "btn_end_dialog": "❌ End chat",
        "btn_new_partner": "🔍 New partner",
        "pls_start": "Please send /start.",
        "btn_end": "❌ End chat",

        "gender_male": "Male",
        "gender_female": "Female",
        "gender_any": "Doesn't matter",

        "confirm_theme": "You selected the topic: {theme}",
        "confirm_sub": "And the subtopic: {sub}",
        
    },
    "es": {
        "choose_lang": "🌍 Por favor, elige un idioma:",
        "welcome_back": "👋 ¡Bienvenido de nuevo, {name}!",
        "enter_nick": "👋 ¡Hola! Escribe tu apodo:",
        "pick_theme": "Elige un tema:",
        "choose_sub": "Ahora elige un subtema:",
        "pick_sub": "Elige un nuevo subtema:",
        "wrong_sub": "Por favor, elige un subtema de la lista.",
        "choose_gender": "Selecciona tu género:",
        "wrong_gender": "Por favor, selecciona tu género:",
        "found": "🎉 ¡Pareja encontrada!\nTema: {theme}\nSubtema: {sub}\nIdioma del interlocutor: {lang}",
        "main_menu": "Elige una acción:",
        "searching": "🔎 Buscando compañero...",
        "default_searching": "⏳ Buscando compañero...",
        "search_stopped": "Búsqueda detenida.",
        "error_fallback": "❌ Algo salió mal. Escribe /start.",
        "sub_any": "Cualquier subtema",
        "support_thanks": "🙏 ¡Gracias por tu apoyo!\n(Aquí aparecerá el enlace de donación)",

        "btn_start": "Comenzar",
        "btn_search": "🔍 Buscar",
        "btn_stop": "⛔ Detener búsqueda",
        "btn_change_sub": "Cambiar subtema",
        "btn_main_menu": "🏠 Menú principal",
        "btn_support": "❤️ Apoyar el proyecto",
        "btn_end_dialog": "❌ Terminar chat",
        "btn_new_partner": "🔍 Nueva pareja",
        "pls_start": "Por favor, envía /start.",
        "btn_end": "❌ Terminar chat",

        "gender_male": "Masculino",
        "gender_female": "Femenino",
        "gender_any": "No importa",

        "confirm_theme": "Has elegido el tema: {theme}",
        "confirm_sub": "Y el subtema: {sub}",
        
    },
    "fr": {
        "choose_lang": "🌍 Veuillez choisir votre langue :",
        "welcome_back": "👋 Bon retour, {name} !",
        "enter_nick": "👋 Salut ! Entrez votre pseudo :",
        "pick_theme": "Choisissez un thème :",
        "choose_sub": "Choisis maintenant une sous-thème :",
        "pick_sub": "Choisissez une nouvelle sous-thème :",
        "wrong_sub": "Veuillez choisir une sous-thème dans la liste.",
        "choose_gender": "Indique ton sexe :",
        "wrong_gender": "Veuillez choisir votre sexe :",
        "found": "🎉 Partenaire trouvé !\nThème : {theme}\nSous‑thème : {sub}\nLangue du partenaire : {lang}",
        "main_menu": "Choisissez une action :",
        "searching": "🔎 Recherche d’un partenaire...",
        "default_searching": "⏳ Recherche en cours...",
        "search_stopped": "Recherche arrêtée.",
        "error_fallback": "❌ Une erreur est survenue. Envoyez /start.",
        "sub_any": "N’importe quel sous-thème",
        "support_thanks": "🙏 Merci pour votre soutien !\n(Un lien de don apparaîtra ici)",

        "btn_start": "Commencer",
        "btn_search": "🔍 Lancer la recherche",
        "btn_stop": "⛔ Arrêter la recherche",
        "btn_change_sub": "Changer le sous‑thème",
        "btn_main_menu": "🏠 Menu principal",
        "btn_support": "❤️ Soutenir le projet",
        "btn_end_dialog": "❌ Terminer la discussion",
        "btn_new_partner": "🔍 Nouveau partenaire",
        "pls_start": "Veuillez envoyer /start.",
        "btn_end": "❌ Terminer la discussion",

        "gender_male": "Homme",
        "gender_female": "Femme",
        "gender_any": "Peu importe",

        "confirm_theme": "Vous avez choisi le thème : {theme}",
        "confirm_sub": "Et le sous-thème : {sub}",
        
    },
    "de": {
        "choose_lang": "🌍 Bitte wähle eine Sprache:",
        "welcome_back": "👋 Willkommen zurück, {name}!",
        "enter_nick": "👋 Hallo! Gib deinen Nick ein:",
        "pick_theme": "Wähle ein Thema:",
        "choose_sub": "Wähle jetzt ein Unterthema:",
        "pick_sub": "Wähle ein neues Unterthema:",
        "wrong_sub": "Bitte wähle ein Unterthema aus der Liste.",
        "choose_gender": "Wähle dein Geschlecht:",
        "wrong_gender": "Bitte wähle dein Geschlecht:",
        "found": "🎉 Gesprächspartner gefunden!\nThema: {theme}\nUnterthema: {sub}\nSprache des Partners: {lang}",
        "main_menu": "Wähle eine Aktion:",
        "searching": "🔎 Suche nach Gesprächspartner...",
        "default_searching": "⏳ Suche läuft...",
        "search_stopped": "Suche gestoppt.",
        "error_fallback": "❌ Etwas ist schiefgelaufen. Sende /start.",
        "sub_any": "Beliebiges Unterthema",
        "support_thanks": "🙏 Vielen Dank für deine Unterstützung!\n(Hier erscheint ein Spendenlink)",

        "btn_start": "Start",
        "btn_search": "🔍 Suche starten",
        "btn_stop": "⛔ Suche stoppen",
        "btn_change_sub": "Unterthema ändern",
        "btn_main_menu": "🏠 Hauptmenü",
        "btn_support": "❤️ Projekt unterstützen",
        "btn_end_dialog": "❌ Gespräch beenden",
        "btn_new_partner": "🔍 Neuer Partner",
        "pls_start": "Bitte sende /start.",
        "btn_end": "❌ Chat beenden",

        "gender_male": "Männlich",
        "gender_female": "Weiblich",
        "gender_any": "Egal",

        "confirm_theme": "Du hast das Thema gewählt: {theme}",
        "confirm_sub": "Und das Unterthema: {sub}",
        
    },
}

def tr_lang(lang: str, key: str, **kw) -> str:
    lang = lang if lang in TEXTS else "ru"
    return TEXTS[lang].get(key, key).format(**kw)

async def tr(user, key: str, **kw) -> str:
    lang = "ru"
    if isinstance(user, dict):
        lang = user.get("lang", "ru")
    elif hasattr(user, "id"):
        from db.user_queries import get_user
        row = await get_user(user.id)
        if row:
            lang = row.get("lang", "ru")
    return tr_lang(lang, key, **kw)

async def tr_user(user_obj, key: str, **kw) -> str:
    return await tr(user_obj, key, **kw)
